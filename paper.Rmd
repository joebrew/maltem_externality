---
title: "Geographic spillover effects of a large scale malaria elimination campaign"
short: "A shorter title"
journal: "AER" # AER, AEJ, PP, JEL
month: "`r lubridate::month(Sys.time())`"
year: "`r lubridate::year(Sys.time())`"
vol: 1
issue: 1
jel:
  - A10
  - A11
keywords:
  - first keyword
  - second keyword
author:
  - name: Alice Anonymous
    firstname: Alice
    surname: Anonymous
    email: alice@example.com
    affiliation: Some Institute of Technology
  - name: Bob Security
    firstname: Bob
    surname: Security
    email: bob@example.com
    affiliation: Another University
acknowledgements: |
  Acknowledgements
abstract: |
  Abstract goes here
output: rticles::aea_article
link-citations: yes
bibliography: bibliography.bib
---

American Economic Review Pointers:

\begin{itemize}
\item Do not use an "Introduction" heading. Begin your introductory material
before the first section heading.

\item Avoid style markup (except sparingly for emphasis).

\item Avoid using explicit vertical or horizontal space.

\item Captions are short and go below figures but above tables.

\item The tablenotes or figurenotes environments may be used below tables
or figures, respectively, as demonstrated below.

\item If you have difficulties with the mathtime package, adjust the package
options appropriately for your platform. If you can't get it to work, just
remove the package or see our technical support document online (please
refer to the author instructions).

\item If you are using an appendix, it goes last, after the bibliography.
Use regular section headings to make the appendix headings.

\item If you are not using an appendix, you may delete the appendix command
and sample appendix section heading.

\item Either the natbib package or the harvard package may be used with bibtex.
To include one of these packages, uncomment the appropriate usepackage command
above. Note: you can't use both packages at once or compile-time errors will result.

\end{itemize}

\section{First Section in Body}

Sample figure:

\begin{figure}
Figure here.

\caption{Caption for figure below.}
\begin{figurenotes}
Figure notes without optional leadin.
\end{figurenotes}
\begin{figurenotes}[Source]
Figure notes with optional leadin (Source, in this case).
\end{figurenotes}
\end{figure}

Sample table:

\begin{table}
\caption{Caption for table above.}

\begin{tabular}{lll}
& Heading 1 & Heading 2 \\
Row 1 & 1 & 2 \\
Row 2 & 3 & 4%
\end{tabular}
\begin{tablenotes}
Table notes environment without optional leadin.
\end{tablenotes}
\begin{tablenotes}[Source]
Table notes environment with optional leadin (Source, in this case).
\end{tablenotes}
\end{table}

References here (manual or bibTeX). If you are using bibTeX, add your bib file
name in place of BibFile in the bibliography command.
% Remove or comment out the next two lines if you are not using bibtex.
\bibliographystyle{aea}
% The appendix command is issued once, prior to all appendices, if any.
\appendix

\section{Mathematical Appendix}



```{r setup, include=FALSE}
knitr::opts_chunk$set(comment = NA, 
               echo = FALSE, 
               warning = FALSE, 
               message = FALSE, 
               error = TRUE, 
               cache = FALSE,
               # fig.height = 4,
               # fig.width = 5,
               fig.align = 'center')
# options(scipen = '999') 

# devtools::install_github("cboettig/knitcitations@v1")
# library(knitcitations); cleanbib()
# cite_options(citation_format = "pandoc", check.entries=FALSE)

```


```{r}
# Get in all BES, weather, etc. data
source('master.R')

# Get a good theme for publication
source('get_theme.R')

```

```{r}
# Classify by contiguousness, etc.
df$location <- 
  ifelse(df$district %in% c('MOAMBA',
                            'MANHICA',
                            'MASSINGIR',
                            'CHOKWE',
                            'BILENE'),
         'Contiguous',
         ifelse(df$district == 'MAGUDE', 'Intervention', 'Control'))

# Define period
df$period <-
  ifelse(df$date >= '2015-10-01', 'Post',
         ifelse(df$date >= '2013-01-01', 'Pre',
                'Historic'))
```

# Introduction

The intervention was associated with a significant reduction in the short-term incidence of malaria in both the first and second season following the initiation of the malaria elimination campaign [@brew]. 


# Methods

We aggregated weekly clinical malaria cases at the district level using data from the Mozambican Boletim Epideniologico Semanal surveillance system, adjusted for population according to those estimates produced by the Mozambican National Statistical Institute. 

We observed the 20 districts of the Gaza and Maputo provinces during the approximately 7 year period from January 2010 through the beginning of March 2017. The malaria elimination campaign was conducted exclusively in Magude. We defined as "contiguous" those 6 districts which shared a border with Magude; the remaining 13 districts were classified as "control" (see figure 1).

```{r}
library(cism)
library(rgeos)
library(maptools)
# Map of area
map <- moz1
map <- map[map@data$NAME_1 %in% c('Maputo', 'Gaza'),]
map_fortified <- broom::tidy(map, region = 'NAME_1')

map2 <- moz2
map2 <- map2[map2@data$NAME_1 %in% c('Maputo', 'Gaza'),]
map2_fortified <- broom::tidy(map2, region = 'NAME_2')

map2_fortified$district <-
  ifelse(map2_fortified$id == 'Magude',
         'Intervention',
         ifelse(map2_fortified$id %in% c('Moamba',
                                         'Manhiça',
                                         'Massingir',
                                         'Chókwè',
                                         'Bilene'),
                'Contiguous',
                'Control'))

cols <- c('darkorange', 'red', 'darkgrey')
area_map <-
  ggplot() +
  geom_polygon(data = map2_fortified,
               aes(x = long,
                   y = lat,
                   group = group,
                   fill = district),
                   alpha = 0.8,
               color = 'black',
               size = 0.5) +
    # geom_label(data = coords@data,
    #            aes(x = lng,
    #                y = lat,
    #                label = district),
    #            size = 2) +
  scale_fill_manual(name = '',
                    values = cols) +
  theme_publication() +
  ggthemes::theme_map() +
  theme(legend.text=element_text(size=8)) +
  labs(title = 'Figure 1: Intervention, spillover, and control areas')
area_map
```

Our analysis consisted of a comparison between the contiguous and control areas both during the period immediately leading up to the intervention (January 1, 2013 through October 10, 2015), as well as the first 1.5 years after the intervention began (October 11, 2015 through March 1, 2017). In a first phase, we calculate the simple cumulative incidence during both the before and after phases for both locations (contiguous and control). We then assess significance by estimating an ordinary least squares model on the weekly incidence asa function of the interaction between the binary time period and location categories.

Thereafter, we quantify the effect of the spillover as the difference between the observed and predicted number of cases during the post-intervention period. Our predicted values come from a binomial probit model which estimates the week-specific individual likelihood of malaria infection, which we then extrapolate to population incidence, trained only on pre-intervention data.

$$
\begin{equation}
\operatorname{Pr}(\text{Malaria} = 1 \mid \text{X}) = \beta_{0} + \beta_{1} \text{Location} + \beta_{2} \text{Month} + \beta_3{ITN}
\end{equation}
$$

Our model accounts not only for the fixed effects of location and seasonality, but also for the potential confounding effects of population coverage by insecticide treated nets. Precipitation and lagged precipitation data were collected and analyzed, but were not included in the model due to lack of granularity (there were only negligible differences between different locations). The time elapsed since the most recent indoor residual spraying (IRS) campaign had taken place in the district, as well as the IRS population coverage were initially included as covariates in the model, but removed after backwards stepwise selection.

All data processing and analysis were carried out in R. All code is online at https://github.com/joebrew/maltem_externality.





# Results

```{r}
pre_avg <- df %>%
  filter(disease == 'MALARIA',
         location == 'Contiguous',
         date >='2013-01-01',
         date <= '2015-10-10') %>%
  summarise(x = sum(cases) / sum(population) * 1000) %>%
  .$x %>% round(digits = 2)

post_avg <- df %>%
  filter(disease == 'MALARIA',
         location == 'Contiguous',
         date > '2015-10-10') %>%
  summarise(x = sum(cases) / sum(population) * 1000) %>%
  .$x %>% round(digits = 2)

pre_avg_season <- df %>%
  filter(disease == 'MALARIA',
         location == 'Contiguous',
         date >='2013-01-01',
         date <= '2015-10-10',
         month %in% c(1:4)) %>%
  summarise(x = sum(cases) / sum(population) * 1000) %>%
  .$x %>% round(digits = 2)

post_avg_season <- df %>%
  filter(disease == 'MALARIA',
         location == 'Contiguous',
         date > '2015-10-10',
         month %in% c(1:4)) %>%
  summarise(x = sum(cases) / sum(population) * 1000) %>%
  .$x %>% round(digits = 2)

pre_avg_control <- df %>%
  filter(disease == 'MALARIA',
         location == 'Control',
         date >='2013-01-01',
         date <= '2015-10-10') %>%
  summarise(x = sum(cases) / sum(population) * 1000) %>%
  .$x %>% round(digits = 2)

post_avg_control <- df %>%
  filter(disease == 'MALARIA',
         location == 'Control',
         date > '2015-10-10') %>%
  summarise(x = sum(cases) / sum(population) * 1000) %>%
  .$x %>% round(digits = 2)

pre_avg_season_control <- df %>%
  filter(disease == 'MALARIA',
         location == 'Control',
         date >='2013-01-01',
         date <= '2015-10-10',
         month %in% c(1:4)) %>%
  summarise(x = sum(cases) / sum(population) * 1000) %>%
  .$x %>% round(digits = 2)

post_avg_season_control <- df %>%
  filter(disease == 'MALARIA',
         location == 'Control',
         date > '2015-10-10',
         month %in% c(1:4)) %>%
  summarise(x = sum(cases) / sum(population) * 1000) %>%
  .$x %>% round(digits = 2)

```

In the 5 districts which shared a border with the intervention zone, the average weekly incidence of malaria fell from `r pre_avg` to `r post_avg` fom the pre-intervention period (January 1, 2013 through October 10, 2015) to the intervention period (October 20, 2015 through Marcy 1, 2017). During the malaria season (defined here as January through April), when the protective spillover effect from the intervention should be at it's greatest, the fall was from `r pre_avg_season` to `r post_avg_season`.

On the other hand, in the 14 control districts, the average weekly incidence of malaria increased from `r pre_avg_control` during the pre intervention period to `r post_avg_control` during the intervention period. The increase was similar during the the malaria seasons before and during the intervention (`r pre_avg_season_control` and `r post_avg_season_control`, respectively).



```{r}
library(knitr)
simple_data <- df %>%
  filter(disease == 'MALARIA') %>%
  filter(date >= '2013-01-01') %>%
  filter(location != 'Intervention') %>%
  mutate(period = ifelse(date <= '2015-10-10',
                           'Before',
                           'After'))
simple_data$location <-
  factor(simple_data$location,
         levels = c('Control', 'Contiguous'))
simple_data$period <- 
  factor(simple_data$period,
         levels = c('Before', 'After'))
simple <- 
  simple_data %>%
  group_by(location, 
           period) %>%
  summarise(cases = sum(cases),
            person_weeks = sum(population)) %>%
  ungroup %>%
  mutate(avg_weekly_incidence = round(cases / person_weeks * 1000, digits = 2))
names(simple) <- Hmisc::capitalize(gsub('_', ' ', names(simple)))
kable(simple)
```

```{r}
simple_model <- lm(pk ~ location + period + location*period,
                   data = simple_data)
ci <- confint(simple_model)

reduction <- round(coef(simple_model)[names(coef(simple_model)) == 'locationContiguous:periodAfter'], digits = 2)
reduction_uncertainty <- round(ci[row.names(ci) == 'locationContiguous:periodAfter'], digits = 2)


simple_model_season <- lm(pk ~ location + period + location*period,
                   data = simple_data %>%
                     filter(month %in% 1:4))
ci_season <- confint(simple_model_season)

reduction_season <- round(coef(simple_model_season)[names(coef(simple_model_season)) == 'locationContiguous:periodAfter'], digits = 2)
reduction_uncertainty_season <- round(ci_season[row.names(ci) == 'locationContiguous:periodAfter'], digits = 2)
```

We estimate the simple spillover effect to be a reduction in the weekly incidence of malaria of `r reduction` cases per 1,000, with a 95% confidence interval of between `r paste0(reduction_uncertainty, collapse = ' and ')`. During the  malaria season, the effect is greater: a reduction of `r reduction_season`, with a 95% confidence interval of between `r paste0(reduction_uncertainty_season, collapse = ' and ')`. 

```{r}
# Get person weeks of risk for the post period in the contiguous
ptar <- simple_data %>%
  filter(period == 'After',
         location == 'Contiguous') %>%
  summarise(x = sum(population)) %>%
  .$x

# Get what WOULD have happened, with control's parameters
simple_data$predicted <- predict(simple_model,
                                 simple_data %>%
                                   mutate(location == 'Control')) + coef(simple_model)[names(coef(simple_model)) == 'locationContiguous']

preds <- predict(simple_model,
                                 simple_data %>%
                                   mutate(location == 'Control'),
                 se.fit = TRUE,
                 interval = 'confidence')$fit + coef(simple_model)[names(coef(simple_model)) == 'locationContiguous']
simple_data$lwr <- preds[,2]
simple_data$upr <- preds[,3]

cases_prevented <- simple_data %>%
  filter(period == 'After',
         location == 'Contiguous') %>%
  summarise(real_cases = sum(cases),
            predicted_cases = sum(predicted * (population/1000)),
            predicted_upper = sum(upr * (population/1000)),
            predicted_lower = sum(lwr * population/1000)) %>%
  mutate(prevented = predicted_cases - real_cases,
         prevented_upper = predicted_upper - real_cases,
         prevented_lower = predicted_lower - real_cases) 
```

The OLS model estimated for the description of the intervention's effects on the contiguous area can also be used as a predictive tool for a hypothetical scenario in which the intervention had not occurred (ie, keeping the fixed effects of the location and period, but manually setting the data on which we predict present as non-contiguous), allowing for the estimation of cases prevented. Doing so shows that the intervention in Magude was associated with an unadjusted positive spillover of `r round(cases_prevented$prevented)` cases prevented during the period from October 10, 2015 through March 1, 2017, with a 95% confidence interval of `r paste0(round(c(cases_prevented$prevented_lower, cases_prevented$prevented_upper), digits = 0), collapse = ' to ')`.



```{r}
# Get grouped by location
by_location <-
  df %>%
  filter(disease == 'MALARIA') %>%
  group_by(date = as.Date(paste0(year, '-', month, '-01')),
           location) %>%
  summarise(cases = sum(cases),
            population = sum(population)) %>%
  ungroup %>%
  mutate(incidence = cases / population * 1000)

label_df <- data_frame(x = as.Date('2015-10-01') + c(-180, 180),
                       y = 13,
                       label = c('Before', 'After'))

ts <-
  ggplot(data = by_location %>%
           filter(date >= '2013-01-01'),
         aes(x = date,
             y = incidence)) +
  geom_line(aes(color = location),
            alpha = 0.8,
            lwd = 2) +
  theme_publication(base_size = 12) +
  scale_colour_publication(name = '') +
  geom_vline(xintercept = as.Date('2015-10-01'),
             alpha = 0.8,
             lty = 2) + 
  geom_text(data = label_df,
             aes(x = x,
                 y = y,
                 label = label),
             size = 6,
            alpha = 0.6) +
  labs(x = 'Month',
       y = 'Incidence per 1,000',
       title = 'Figure 2: Monthly malaria incidence')
ts
```

```{r, fig.height = 6, fig.width = 6}
# Decline chart
decline_data <-
  df %>%
  filter(disease == 'MALARIA') %>%
  filter(date >= '2013-01-01') %>%
  group_by(date = factor(ifelse(date <= '2015-10-01',
                         'Before', 'After'),
                         levels = c('Before', 'After')),
           location) %>%
  summarise(cases = sum(cases),
            population = sum(population)) %>%
  ungroup %>%
  mutate(incidence = cases / population * 1000) %>%
  group_by(location) %>%
  mutate(p = incidence / incidence[date == 'Before'] * 100)

g1 <- ggplot(data = decline_data,
       aes(x = date,
           y = incidence,
           group = location,
           color = location)) +
  geom_point(size = 3, 
             alpha = 0.8) +
  geom_line(alpha = 0.6,
            size = 2) +
  geom_label(aes(y = incidence - 0.3,
                 label = round(incidence, 2)),
             show.legend = FALSE) +
  theme_publication(base_size = 8) +
  scale_colour_publication(name = '') +
  labs(x = 'Time',
       y = 'Average weekly incidence per 1,000',
       title = 'Before and after incidence estimates') +
  ylim(0, 7)


g2 <- ggplot(data = decline_data,
       aes(x = date,
           y = p,
           group = location,
           color = location)) +
  geom_point(size = 3, 
             alpha = 0.8) +
  geom_line(alpha = 0.6,
            size = 2) +
  geom_label(data = decline_data %>%
               filter(date != 'Before'),
             aes(y = p - 5,
                 label = round(p, 2)),
             show.legend = FALSE) +
  theme_publication(base_size = 8) +
  scale_colour_publication(name = '') +
  labs(x = 'Time',
       y = 'Percent of pre-intervention incidence',
       title = 'Incidence as % of pre-intervention incidence') +
  ylim(0, 125) +
  geom_hline(yintercept = 100,
             lty = 2,
             alpha = 0.6)

library(gridExtra)
grid.arrange(g1, g2, top = textGrob("Figure 3", gp=gpar(fontsize=15, fontface = 2)), ncol = 2)

```

```{r, fig.height = 7, fig.width = 7}
# Construction of counterfactual
model_data <- df %>%
            filter(disease == 'MALARIA',
                   district != 'MAGUDE') %>%
  group_by(location, 
           year, 
           season = ifelse(month %in% 1:4, 'rainy', 'not-rainy'),
           date = as.Date(paste0(year, '-', month, '-01')), 
           month) %>%
  summarise(cases = sum(cases),
            population = sum(population),
            irs_coverage_people = mean(irs_coverage_people),
            weeks_since_last_irs_campaign_end = mean(weeks_since_last_irs_campaign_end),
            itn_coverage = mean(itn_coverage)) %>%
  ungroup %>%
  mutate(p = cases / population) %>%
  mutate(pk = cases / population * 1000) %>%
  filter(date >= '2013-01-01')

fit <- glm(p ~ 
            factor(month) +
            location +
             # year + season*year  + 
            # season +
            # irs_coverage_people*weeks_since_last_irs_campaign_end + 
            itn_coverage,
           family = binomial('probit'),
          data = model_data %>%
            filter(date <= '2015-10-01'))

model_data$predicted <- predict(fit, model_data)

plot_data <-
  model_data %>%
  dplyr::select(date, location, pk, predicted) %>%
  rename(observed = pk) %>%
  mutate(prediction_error = observed - predicted) %>%
  gather(key = key, value = value, observed:prediction_error)

cols <- c('red', 'black')
observed_vs_predicted <- ggplot(data = plot_data %>%
               filter(key != 'prediction_error') %>%
               mutate(key = Hmisc::capitalize(key)),
       aes(x = date,
           y = value,
           color = key)) +
  geom_line() +
  facet_wrap(~location) +
  theme_publication(base_size = 8) +
  scale_color_manual(name = '',
                     values = cols) +
  labs(x = 'Date',
       y = 'Weekly incidence per 1,000',
       title = 'Observed vs predicted') +
  geom_vline(xintercept = as.Date('2015-10-01'),
             alpha = 0.8,
             lty = 2)

prediction_error <- ggplot(data = plot_data %>%
               filter(key == 'prediction_error') %>%
               mutate(key = 'Prediction error'),
       aes(x = date,
           y = value,
           color = key)) +
  geom_line() +
  facet_wrap(~location) +
    facet_wrap(~location) +
  theme_publication(base_size = 8) +
  scale_color_manual(name = '',
                     values = cols) +
  labs(x = 'Date',
       y = 'Weekly incidence per 1,000',
       title = 'Difference between observed and predicted') +
  geom_hline(yintercept = 0,
             alpha = 0.7,
             lty = 2) +
  geom_vline(xintercept = as.Date('2015-10-01'),
             alpha = 0.8,
             lty = 2) 

grid.arrange(observed_vs_predicted,
             prediction_error,
             top = textGrob("Figure 4: Model-adjusted spillover effect", gp=gpar(fontsize=15, fontface = 2)))
```

# Discussion


# Bibliography

\bibliography{bibliography.bib}


