--- 
title: "Positive externalities of a malaria elimination campaign"
author: "Joe Brew"
site: bookdown::bookdown_site
output: bookdown::html_book
documentclass: book
bibliography: [book.bib, packages.bib, bibliography.bib]
biblio-style: apalike
link-citations: yes
github-repo: joebrew/maltem_externality
description: "Here is a basic description."
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(comment = NA, 
               echo = FALSE, 
               warning = FALSE, 
               message = FALSE, 
               error = TRUE, 
               cache = FALSE,
               out.width='80%', fig.asp=.75, fig.align='center')

# devtools::install_github("cboettig/knitcitations@v1")
# library(knitcitations); cleanbib()
# cite_options(citation_format = "pandoc", check.entries=FALSE)
# 
# rmarkdown::draft("MyJSSArticle.Rmd", template = "jss_article", package = "rticles") 



```


```{r, cache = FALSE}
# Get in all BES, weather, etc. data
source('../master.R', chdir = TRUE)

# Get a good theme for publication
source('../get_theme.R', chdir = TRUE)

library(tidyverse)
# library(extrafont)
# extrafont::font_import() # Run only once  
# loadfonts()

# Get rmarkdown formats
# rmarkdown::draft("sim.Rmd", template = "sim_article", package = "rticles")
```



```{r}
# Classify by contiguousness, etc.
df$location <- 
  ifelse(df$district %in% c('MOAMBA',
                            'MANHICA',
                            'MASSINGIR',
                            'CHOKWE',
                            'BILENE'),
         'Contiguous',
         ifelse(df$district == 'MAGUDE', 'Intervention', 'Control'))

# Define period
df$period <-
  ifelse(df$date >= '2015-10-01', 'Post',
         ifelse(df$date >= '2013-01-01', 'Pre',
                'Historic'))
```


```{r include=FALSE}
# automatically create a bib database for R packages
knitr::write_bib(c(
  .packages(), 'bookdown', 'knitr', 'rmarkdown'
), 'packages.bib')
```




# Introduction {#intro}



The intervention was associated with a significant reduction in the short-term incidence of malaria in both the first and second season following the initiation of the malaria elimination campaign [@brew]. 





# Methods {#methods}


We aggregated weekly clinical malaria cases at the district level using data from the Mozambican Boletim Epideniologico Semanal surveillance system, adjusted for population according to those estimates produced by the Mozambican National Statistical Institute. 

We observed the 20 districts of the Gaza and Maputo provinces during the approximately 7 year period from January 2010 through the beginning of March 2017. The malaria elimination campaign was conducted exclusively in Magude. We defined as "contiguous" those 6 districts which shared a border with Magude; the remaining 13 districts were classified as "control" (see Figure  \@ref(fig:figure-1)).

```{r figure-1, fig.cap='Some map', out.width='80%', fig.asp=.75, fig.align='center'}
library(cism)
library(rgeos)
library(maptools)
# Map of area
map <- moz1
map <- map[map@data$NAME_1 %in% c('Maputo', 'Gaza'),]
map_fortified <- broom::tidy(map, region = 'NAME_1')

map2 <- moz2
map2 <- map2[map2@data$NAME_1 %in% c('Maputo', 'Gaza'),]
map2_fortified <- broom::tidy(map2, region = 'NAME_2')

map2_fortified$district <-
  ifelse(map2_fortified$id == 'Magude',
         'Intervention',
         ifelse(map2_fortified$id %in% c('Moamba',
                                         'Manhiça',
                                         'Massingir',
                                         'Chókwè',
                                         'Bilene'),
                'Contiguous',
                'Control'))

cols <- c('darkorange', 'red', 'darkgrey')
area_map <-
  ggplot() +
  geom_polygon(data = map2_fortified,
               aes(x = long,
                   y = lat,
                   group = group,
                   fill = district),
                   alpha = 0.8,
               color = 'black',
               size = 0.5) +
    # geom_label(data = coords@data,
    #            aes(x = lng,
    #                y = lat,
    #                label = district),
    #            size = 2) +
  scale_fill_manual(name = '',
                    values = cols) +
  theme_publication() +
  ggthemes::theme_map() +
  theme(legend.text=element_text(size=8)) +
  labs(title = 'Figure 1: Intervention, spillover, and control areas')
area_map
```

Our analysis consisted of a comparison between the contiguous and control areas both during the period immediately leading up to the intervention (January 1, 2013 through October 10, 2015), as well as the first 1.5 years after the intervention began (October 11, 2015 through March 1, 2017). In a first phase, we calculate the simple cumulative incidence during both the before and after phases for both locations (contiguous and control). We then assess significance by estimating an ordinary least squares model on the weekly incidence asa function of the interaction between the binary time period and location categories.

Thereafter, we quantify the effect of the spillover as the difference between the observed and predicted number of cases during the post-intervention period. Our predicted values come from a binomial probit model which estimates the week-specific individual likelihood of malaria infection, which we then extrapolate to population incidence, trained only on pre-intervention data.

$$
\begin{equation}
\operatorname{Pr}(\text{Malaria} = 1 \mid \text{X}) = \beta_{0} + \beta_{1} \text{Location} + \beta_{2} \text{Month} + \beta_3{ITN}
\end{equation}
$$


Our model accounts not only for the fixed effects of location and seasonality, but also for the potential confounding effects of population coverage by insecticide treated nets. Precipitation and lagged precipitation data were collected and analyzed, but were not included in the model due to lack of granularity (there were only negligible differences between different locations). The time elapsed since the most recent indoor residual spraying (IRS) campaign had taken place in the district, as well as the IRS population coverage were initially included as covariates in the model, but removed after backwards stepwise selection.

All data processing and analysis were carried out in R. All code is online at https://github.com/joebrew/maltem_externality.

# Results {#results}

As per the methods \@ref(methods), we do the following. 

```{r}
pre_avg <- df %>%
  filter(disease == 'MALARIA',
         location == 'Contiguous',
         date >='2013-01-01',
         date <= '2015-10-10') %>%
  summarise(x = sum(cases) / sum(population) * 1000) %>%
  .$x %>% round(digits = 2)

post_avg <- df %>%
  filter(disease == 'MALARIA',
         location == 'Contiguous',
         date > '2015-10-10') %>%
  summarise(x = sum(cases) / sum(population) * 1000) %>%
  .$x %>% round(digits = 2)

pre_avg_season <- df %>%
  filter(disease == 'MALARIA',
         location == 'Contiguous',
         date >='2013-01-01',
         date <= '2015-10-10',
         month %in% c(1:4)) %>%
  summarise(x = sum(cases) / sum(population) * 1000) %>%
  .$x %>% round(digits = 2)

post_avg_season <- df %>%
  filter(disease == 'MALARIA',
         location == 'Contiguous',
         date > '2015-10-10',
         month %in% c(1:4)) %>%
  summarise(x = sum(cases) / sum(population) * 1000) %>%
  .$x %>% round(digits = 2)

pre_avg_control <- df %>%
  filter(disease == 'MALARIA',
         location == 'Control',
         date >='2013-01-01',
         date <= '2015-10-10') %>%
  summarise(x = sum(cases) / sum(population) * 1000) %>%
  .$x %>% round(digits = 2)

post_avg_control <- df %>%
  filter(disease == 'MALARIA',
         location == 'Control',
         date > '2015-10-10') %>%
  summarise(x = sum(cases) / sum(population) * 1000) %>%
  .$x %>% round(digits = 2)

pre_avg_season_control <- df %>%
  filter(disease == 'MALARIA',
         location == 'Control',
         date >='2013-01-01',
         date <= '2015-10-10',
         month %in% c(1:4)) %>%
  summarise(x = sum(cases) / sum(population) * 1000) %>%
  .$x %>% round(digits = 2)

post_avg_season_control <- df %>%
  filter(disease == 'MALARIA',
         location == 'Control',
         date > '2015-10-10',
         month %in% c(1:4)) %>%
  summarise(x = sum(cases) / sum(population) * 1000) %>%
  .$x %>% round(digits = 2)

```

In the 5 districts which shared a border with the intervention zone, the average weekly incidence of malaria fell from `r pre_avg` to `r post_avg` fom the pre-intervention period (January 1, 2013 through October 10, 2015) to the intervention period (October 20, 2015 through Marcy 1, 2017). During the malaria season (defined here as January through April), when the protective spillover effect from the intervention should be at it's greatest, the fall was from `r pre_avg_season` to `r post_avg_season`.

On the other hand, in the 14 control districts, the average weekly incidence of malaria increased from `r pre_avg_control` during the pre intervention period to `r post_avg_control` during the intervention period. The increase was similar during the the malaria seasons before and during the intervention (`r pre_avg_season_control` and `r post_avg_season_control`, respectively).



```{r}
library(knitr)
simple_data <- df %>%
  filter(disease == 'MALARIA') %>%
  filter(date >= '2013-01-01') %>%
  filter(location != 'Intervention') %>%
  mutate(period = ifelse(date <= '2015-10-10',
                           'Before',
                           'After'))
simple_data$location <-
  factor(simple_data$location,
         levels = c('Control', 'Contiguous'))
simple_data$period <- 
  factor(simple_data$period,
         levels = c('Before', 'After'))
simple <- 
  simple_data %>%
  group_by(location, 
           period) %>%
  summarise(cases = sum(cases),
            person_weeks = sum(population)) %>%
  ungroup %>%
  mutate(avg_weekly_incidence = round(cases / person_weeks * 1000, digits = 2))
names(simple) <- Hmisc::capitalize(gsub('_', ' ', names(simple)))
kable(simple)
```

```{r}
simple_model <- lm(pk ~ location + period + location*period,
                   data = simple_data)
ci <- confint(simple_model)

reduction <- round(coef(simple_model)[names(coef(simple_model)) == 'locationContiguous:periodAfter'], digits = 2)
reduction_uncertainty <- round(ci[row.names(ci) == 'locationContiguous:periodAfter'], digits = 2)


simple_model_season <- lm(pk ~ location + period + location*period,
                   data = simple_data %>%
                     filter(month %in% 1:4))
ci_season <- confint(simple_model_season)

reduction_season <- round(coef(simple_model_season)[names(coef(simple_model_season)) == 'locationContiguous:periodAfter'], digits = 2)
reduction_uncertainty_season <- round(ci_season[row.names(ci) == 'locationContiguous:periodAfter'], digits = 2)
```

We estimate the simple spillover effect to be a reduction in the weekly incidence of malaria of `r reduction` cases per 1,000, with a 95% confidence interval of between `r paste0(reduction_uncertainty, collapse = ' and ')`. During the  malaria season, the effect is greater: a reduction of `r reduction_season`, with a 95% confidence interval of between `r paste0(reduction_uncertainty_season, collapse = ' and ')`. 

```{r}
# Get person weeks of risk for the post period in the contiguous
ptar <- simple_data %>%
  filter(period == 'After',
         location == 'Contiguous') %>%
  summarise(x = sum(population)) %>%
  .$x

# Get what WOULD have happened, with control's parameters
simple_data$predicted <- predict(simple_model,
                                 simple_data %>%
                                   mutate(location == 'Control')) + coef(simple_model)[names(coef(simple_model)) == 'locationContiguous']

preds <- predict(simple_model,
                                 simple_data %>%
                                   mutate(location == 'Control'),
                 se.fit = TRUE,
                 interval = 'confidence')$fit + coef(simple_model)[names(coef(simple_model)) == 'locationContiguous']
simple_data$lwr <- preds[,2]
simple_data$upr <- preds[,3]

cases_prevented <- simple_data %>%
  filter(period == 'After',
         location == 'Contiguous') %>%
  summarise(real_cases = sum(cases),
            predicted_cases = sum(predicted * (population/1000)),
            predicted_upper = sum(upr * (population/1000)),
            predicted_lower = sum(lwr * population/1000)) %>%
  mutate(prevented = predicted_cases - real_cases,
         prevented_upper = predicted_upper - real_cases,
         prevented_lower = predicted_lower - real_cases) 
```


The OLS model estimated for the description of the intervention's effects on the contiguous area can also be used as a predictive tool for a hypothetical scenario in which the intervention had not occurred (ie, keeping the fixed effects of the location and period, but manually setting the data on which we predict present as non-contiguous), allowing for the estimation of cases prevented. Doing so shows that the intervention in Magude was associated with an unadjusted positive spillover of `r round(cases_prevented$prevented)` cases prevented during the period from October 10, 2015 through March 1, 2017, with a 95% confidence interval of `r paste0(round(c(cases_prevented$prevented_lower, cases_prevented$prevented_upper), digits = 0), collapse = ' to ')`.

# Discussion

Some text goes here.


```{r nice-fig, fig.cap='Here is a nice figure!', out.width='80%', fig.asp=.75, fig.align='center'}
par(mar = c(4, 4, .1, .1))
plot(pressure, type = 'b', pch = 19)
```

Reference a figure by its code chunk label with the `fig:` prefix, e.g., see Figure \@ref(fig:nice-fig). Similarly, you can reference tables generated from `knitr::kable()`, e.g., see Table \@ref(tab:nice-tab).

```{r nice-tab, tidy=FALSE}
knitr::kable(
  head(iris, 20), caption = 'Here is a nice table!',
  booktabs = TRUE
)
```


# References
